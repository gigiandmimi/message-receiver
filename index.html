<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>共享留言板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl md:text-3xl font-bold text-center mb-6">
            <i class="fa fa-comments text-blue-600"></i> 多条路留言板
        </h1>

        <!-- 留言列表 -->
        <div class="bg-white rounded-lg shadow mb-6 p-4">
            <h2 class="text-lg font-semibold mb-4">
                <i class="fa fa-list-alt text-blue-600"></i> 留言列表
                <span id="count" class="text-sm text-gray-500 ml-2">(0条)</span>
            </h2>
            <div id="notes" class="min-h-[200px] max-h-[400px] overflow-y-auto">
                <div id="loading" class="text-center py-8 text-gray-500">
                    <i class="fa fa-circle-o-notch fa-spin"></i> 加载中...
                </div>
                <div id="error" class="hidden text-center py-8 text-red-500">
                    <i class="fa fa-exclamation-triangle"></i> 加载失败
                </div>
                <div id="empty" class="hidden text-center py-8 text-gray-500">
                    <i class="fa fa-pencil"></i> 还没有留言，快来添加第一条吧
                </div>
            </div>
        </div>

        <!-- 留言表单 -->
        <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-lg font-semibold mb-4">
                <i class="fa fa-pencil text-blue-600"></i> 发表留言
            </h2>
            <form id="form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">昵称</label>
                    <input type="text" id="author" required 
                        class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">内容</label>
                    <textarea id="content" rows="3" required 
                        class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" 
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
                    发布留言
                </button>
            </form>
        </div>
    </div>

    <script>
        // 基础配置
        const API_URL = '/api/messages';
        let displayedIds = new Set();
        
        // DOM元素
        const notesEl = document.getElementById('notes');
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const emptyEl = document.getElementById('empty');
        const countEl = document.getElementById('count');
        const formEl = document.getElementById('form');
        const authorEl = document.getElementById('author');
        const contentEl = document.getElementById('content');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', loadNotes);
        formEl.addEventListener('submit', submitNote);
        
        // 加载留言
        async function loadNotes() {
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error('加载失败');
                
                const notes = await res.json();
                
                // 显示状态处理
                if (notes.length === 0) {
                    showElement(emptyEl);
                    countEl.textContent = '(0条)';
                    return;
                }
                
                // 隐藏所有状态
                [loadingEl, errorEl, emptyEl].forEach(el => el.classList.add('hidden'));
                
                // 添加新留言
                let newCount = 0;
                notes.forEach(note => {
                    if (!displayedIds.has(note.id)) {
                        displayedIds.add(note.id);
                        notesEl.prepend(createNoteElement(note));
                        newCount++;
                    }
                });
                
                // 更新计数
                countEl.textContent = `(${displayedIds.size}条)`;
                
            } catch (err) {
                console.error('加载错误:', err);
                showElement(errorEl);
            }
        }
        
        // 创建留言元素
        function createNoteElement(note) {
            const div = document.createElement('div');
            div.className = 'border-l-4 border-blue-500 bg-gray-50 p-3 mb-3';
            div.innerHTML = `
                <div class="flex justify-between">
                    <span class="font-medium">${escapeHtml(note.author)}</span>
                    <span class="text-xs text-gray-500">${new Date(note.timestamp).toLocaleString()}</span>
                </div>
                <p class="mt-1 text-gray-700">${escapeHtml(note.content)}</p>
            `;
            return div;
        }
        
        // 提交留言
        async function submitNote(e) {
            e.preventDefault();
            const author = authorEl.value.trim();
            const content = contentEl.value.trim();
            
            if (!author || !content) {
                alert('请填写昵称和内容');
                return;
            }
            
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ author, content })
                });
                
                if (!res.ok) throw new Error('发布失败');
                
                // 重置表单并刷新
                authorEl.value = '';
                contentEl.value = '';
                loadNotes();
                
            } catch (err) {
                alert('发布失败: ' + err.message);
            }
        }
        
        // 工具函数
        function showElement(el) {
            [loadingEl, errorEl, emptyEl].forEach(e => e.classList.add('hidden'));
            el.classList.remove('hidden');
        }
        
        function escapeHtml(str) {
            return str.replace(/[&<>"']/g, char => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;',
                '"': '&quot;', "'": '&#39;'
            }[char]));
        }
    </script>
</body>
</html>
    
